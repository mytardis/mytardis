{% extends "tardis_portal/portal_template.html" %}
{% load basiccomparisonfilters %}
{% load uploadify_tags %}
{% load dynurl %}

{% block script %}

<script type="text/javascript">
	
	function get_new_parameter_name(name)
	{
		var new_name = name;

		var i = 1;
		while($("input[name=" + new_name + "__" + i + "]").length == 1)
		{
			i++;
		}
		return new_name + "__" + i;
	}

	function get_form_input_html(label, name)
	{
		return '<div class="fieldWrapper"><label for="' + name + '">' + label + '</label><br/><input type="text" name="' + name + '" value="" id="' + name + '" /></div>';
	}

	$('#schemaselect').live('change', function(e) {
		e.preventDefault();

        var $this = $(this);
        var $jqm_content_div = $this.closest('.jqmAlertContent');

        var type = $this.attr('data-type');
        var parent_object_id = $this.attr('data-parent_object_id');
        var href = "/ajax/add_" + type + "_parameters/" + parent_object_id + "/?schema_id=" + $this.val();
		$.get(href, function(data) {
            $jqm_content_div.html(data);
        });
		return false;
	});
	$('#add_new_parameter').live('click', function(){		
		$("#parameternameselect > option:selected").each(function() {
            var $selected_option = $(this);
			var new_element_name = get_new_parameter_name($selected_option.val());
			$("#parameternameselect").before(get_form_input_html($selected_option.text(), new_element_name));
			$("#" + new_element_name).focus();
		});
	});
    $('#add_metadata_form').live('submit', function(e) {
        e.preventDefault();

        var $form = $(this);
        var form_data = $form.serialize();

        var schema_id = $('#schemaselect').val();
        var $jqm_content_div = $form.closest('.jqmAlertContent');
        var type = $form.attr('data-type');
        var parent_object_id = $form.attr('data-parent_object_id');
        var href = "/ajax/add_" + type + "_parameters/" + parent_object_id + "/?schema_id=" + schema_id;
        $.post(href, form_data, function(data) {
            $jqm_content_div.html(data);
        });
        return false;
    });
    $('#edit_metadata_form').live('submit', function(e) {
        e.preventDefault();
        var $form = $(this);

        $.post($form.attr('action'), $form.serialize(), function(data) {
              $('#jqmAlertExpEdit div.jqmAlertContent').html(data);
        });
        return false;
    });

    function refreshMetadataDisplay(hash){
        var $trigger = $(hash.t);
        var $toggle = $($trigger.attr('data-toggle_selector'));
        if ($toggle.hasClass('metadata_shown')) {
            $toggle.click(); // hide
            $toggle.click(); // show
            // outcome is a refresh
        } else {
            $toggle.click(); // show
        }
        hash.w.fadeOut();
        hash.w.css('opacity', '100%'); // must be set otherwise popup will be displayed but not visible the second time
    }

	$(document).ready(function() {
        $("#tabs").tabs({
            ajaxOptions: {dataType: "html"},
            cookie: { expires: 30 }
        });

        // Close Button Highlighting. IE doesn't support :hover. Surprise?
        if($.browser.msie) {
            $('div.jqmAlert .jqmClose').hover(
                function(){ $(this).addClass('jqmCloseHover'); },
                function(){ $(this).removeClass('jqmCloseHover');}
            );
        }

        $('#jqmAlertExpAdd, #jqmAlertExpEdit').jqm({
            ajax: '@href',
            target: '.jqmAlertContent',
            overlay: false,
            closeClass: 'jqmClose',
            onHide: refreshMetadataDisplay
        });

    });

	var loadingHTML = "<img src='/site_media/images/ajax-loader.gif'/><br />";
	// metadata text / ajax toggle
    $(".dataset_metadata_toggle").live('click', function(e){
        var $this = $(this);
        var $dataset_metadata = $this.next();
        var $icon = $this.find('span');

        $this.toggleClass('metadata_shown metadata_hidden');
        $icon.toggleClass('ui-icon-circle-triangle-e ui-icon-circle-triangle-s');

        if($this.hasClass('metadata_shown')) {
            var href= $this.attr("href");

            $dataset_metadata.html(loadingHTML);
            $dataset_metadata.load(href);
            $dataset_metadata.show();
        } else {
            $dataset_metadata.hide();
        }
        return false;
    });
    $(".experiment_metadata_toggle").live('click', function(e){
        var $this = $(this);
        var $experiment_metadata = $('.experiment_metadata');
        var $icon = $this.find('span');

        $this.toggleClass('metadata_shown metadata_hidden');
        $icon.toggleClass('ui-icon-circle-triangle-e ui-icon-circle-triangle-s');

        if($this.hasClass('metadata_shown')) {
            var href= $this.attr("href");

            $experiment_metadata.html(loadingHTML);
            $experiment_metadata.load(href);
            $experiment_metadata.show();
        } else {
            $experiment_metadata.hide();
        }
        return false;
    });
    $('#expAddTrigger').live('click', function(evt){
        evt.preventDefault();

        // r14 code example on jqmodal's site doesn't work - use old-fashioned "this" as an arg to jqmShow
        $('#jqmAlertExpAdd').jqmShow(this); 
    });
    $('.jqModalExpEdit').live('click', function(evt){
        evt.preventDefault();
        // r14 code example on jqmodal's site doesn't work - use old-fashioned "this" as an arg to jqmShow
        $('#jqmAlertExpEdit').jqmShow(this); 
    });
    $('.jqModalDsEdit').live('click', function(evt) {
        evt.preventDefault();
        // r14 code example on jqmodal's site doesn't work - use old-fashioned "this" as an arg to jqmShow
        $('#jqmAlertExpEdit').jqmShow(this); 
    });
    $('.jqModalDsAdd').live('click', function(evt) {
        evt.preventDefault();

        // r14 code example on jqmodal's site doesn't work - use old-fashioned "this" as an arg to jqmShow
        $('#jqmAlertExpAdd').jqmShow(this); 
    });

</script>

{% endblock %}

{% block fullpage %}

   <div class="jqmAlert" id="jqmAlertExpAdd">

       <div class="jqmAlertWindow">
           <div class="jqmAlertTitle clearfix">
           <h1>Add Parameters</h1><a href="#" class="jqmClose"><em>Close</em></a>
         </div>

         <div class="jqmAlertContent" id="jqmAlertContentexperimentA{{experiment.id}}">
         <p>Please wait... <img src="/site_media/images/ajax-loader.gif" alt="loading" /></p>
         </div>
       </div>
   </div>

	<div class="jqmAlert" id="jqmAlertExpEdit">

		<div class="jqmAlertWindow">
		    <div class="jqmAlertTitle clearfix">
		    <h1>Edit Parameters</h1><a href="#" class="jqmClose"><em>Close</em></a>
		  </div>

		  <div class="jqmAlertContent">
		  <p>Please wait... <img src="/site_media/images/ajax-loader.gif" alt="loading" /></p>
		  </div>
		</div>
	</div>

  <div id="fullpage">
    <div class="post">
      <h1 class="title">{{ experiment.title }}</h1>
        {% if has_write_permissions %}{% if not experiment.public %}
           <a href="{{ experiment.get_edit_url }}">[Edit]</a>
	{% endif %}{% endif %}
      </h1>
    </div>

    <div class="tabcontainer">
      <div id="tabs">
	<ul>
	  <li><a href="{% url tardis.tardis_portal.views.experiment_description experiment.id %}">Description</a></li>
      <li><a href="{% url tardis.tardis_portal.views.experiment_datasets experiment.id %}{% if query %}?query={{ query }}{% endif %}">Datasets ({{ experiment.dataset_set.count }})</a></li>
	  {% for appurl, appname in apps %}
	    <li><a href="{% dynurl appurl experiment.id %}">{{ appname }}</a></li>
	  {% endfor %}
	</ul>
      </div><!-- End tab container -->

    </div>
  </div>

{% endblock %}
