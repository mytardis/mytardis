{% extends "tardis_portal/portal_template.html" %}
{% load basiccomparisonfilters %}
{% load uploadify_tags %}
{% load dynurl %}

{% block script %}

<script type="text/javascript">
	
	function get_new_parameter_name(name)
	{
		var new_name = name;

		var i = 1;
		while($("input[name=" + new_name + "__" + i + "]").length == 1)
		{
			i++;
		}
		return new_name + "__" + i;
	}

	function get_form_input_html(label, name)
	{
		return '<div class="fieldWrapper"><label for="' + name + '">' + label + '</label><br/><input type="text" name="' + name + '" value="" id="' + name + '" /></div>';
	}

	$('#schemaselect').live('change', function(e) {
		e.preventDefault();

        var $this = $(this);
        var $jqm_content_div = $this.closest('.jqmAlertContent');

        var type = $this.attr('data-type');
        var parent_object_id = $this.attr('data-parent_object_id');
        var href = "/ajax/add_" + type + "_parameters/" + parent_object_id + "/?schema_id=" + $this.val();
		$.get(href, function(data) {
            $jqm_content_div.html(data);
            return false;
        });
		return false;
	});
	$('#add_new_parameter').live('click', function(){		
        var $this = $(this);
        var $form = $this.closest('form');
        var type = $form.attr('data-type');
        var parent_object_id = $form.attr('data-parent_object_id');

		$("#parameternameselect_" + type + "_" + parent_object_id + ">option:selected").each(function() {
            var $selected_option = $(this);
			var new_element_name = get_new_parameter_name($selected_option.val());
			$("#parameternameselect_" + type + "_" + parent_object_id).before(get_form_input_html($selected_option.text(), new_element_name));
			$("#" + new_element_name).focus();
		});
	});
    $('#add_metadata_form').live('submit', function(e) {
        e.preventDefault();

        var $form = $(this);
        var form_data = $form.serialize();

        var schema_id = $('#schemaselect').val();
        var $jqm_content_div = $form.closest('.jqmAlertContent');
        var type = $form.attr('data-type');
        var parent_object_id = $form.attr('data-parent_object_id');
        var href = "/ajax/add_" + type + "_parameters/" + parent_object_id + "/?schema_id=" + schema_id;
        $.post(href, form_data, function(data) {
            $jqm_content_div.html(data);
        });
        return false;
    });

	$(document).ready(function() {
        $("#tabs").tabs({
            ajaxOptions: {dataType: "html"},
            cookie: { expires: 30 },
        });

        // Close Button Highlighting. IE doesn't support :hover. Surprise?
        if($.browser.msie) {
            $('div.jqmAlert .jqmClose').hover(
                function(){ $(this).addClass('jqmCloseHover'); },
                function(){ $(this).removeClass('jqmCloseHover');}
            );
        }

    });
</script>

{% endblock %}

{% block fullpage %}

  <div id="fullpage">
    <div class="post">
      <h1 class="title">{{ experiment.title }}</h1>
        {% if has_write_permissions %}{% if not experiment.public %}
           <a href="{{ experiment.get_edit_url }}">[Edit]</a>
	{% endif %}{% endif %}
      </h1>
    </div>

    <div class="tabcontainer">
      <div id="tabs">
	<ul>
	  <li><a href="{% url tardis.tardis_portal.views.experiment_description experiment.id %}">Description</a></li>
      <li><a href="{% url tardis.tardis_portal.views.experiment_datasets experiment.id %}{% if query %}?query={{ query }}{% endif %}">Datasets ({{ experiment.dataset_set.count }})</a></li>
	  {% for appurl, appname in apps %}
	    <li><a href="{% dynurl appurl experiment.id %}">{{ appname }}</a></li>
	  {% endfor %}
	</ul>
      </div><!-- End tab container -->

    </div>
  </div>

{% endblock %}
