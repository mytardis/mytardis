{% block script %}

<script type="text/javascript" charset="utf-8">
	var loadingHTML = "<img src='/site_media/images/ajax-loader.gif'/><br />";

	// metadata text / ajax toggle

	$(document).ready(function(){

		$(".experiment_metadata_toggle").live('click', function(e){
            var $this = $(this);
            var $experiment_metadata = $('.experiment_metadata');
            var $icon = $this.find('span');

            $this.toggleClass('metadata_shown metadata_hidden');
            $icon.toggleClass('ui-icon-circle-triangle-e ui-icon-circle-triangle-s');

			if($this.hasClass('metadata_shown')) {
				var href= $this.attr("href");

		    	$experiment_metadata.html(loadingHTML);
		        $experiment_metadata.load(href);
				$experiment_metadata.show();
			} else {
				$experiment_metadata.hide();
			}
			return false;
		});
	});

    function refreshMetadataDisplay(hash) {
        var toggle = $('.experiment_metadata_toggle');
        if (toggle.hasClass('metadata_shown')) {
            toggle.click(); // hide
            toggle.click(); // show
            // outcome is a refresh
        } else {
            toggle.click(); // show
        }
        hash.w.fadeOut();
        hash.w.css('opacity', '100%'); // must be set otherwise popup will be displayed but not visible the second time
    }
    $('#jqmAlertExpA{{experiment.id}}').die();
    $('#jqmAlertExpA{{experiment.id}}').jqm({
        trigger: '.jqModalExpA{{experiment.id}}',
        ajax: '@href',
        target: '#jqmAlertContentexperimentA{{experiment.id}}',
        overlay: 0,
        closeClass: 'jqmClose',
        onHide: refreshMetadataDisplay
    });
</script>
{% endblock %}

<div id="experiment_description">

  <p>
    <strong>Authors: </strong><br/>
    {% for author in authors %}
      {{ author.author }}{% if not forloop.last %},{% endif %}
    {% endfor %}
  </p>

  <p>
    <strong>Abstract: </strong>
    <div class="abstract">
      {{ experiment.description|safe }}
    </div>
  </p>

  {% if experiment.handle %}
    <p>
      <strong>Persistent Handle:</strong>
      <a href="{{ handle }}/{{ experiment.handle }}">{{ experiment.handle }}</a><br/>
    </p>
  {% endif %}

  <p>
    <strong>Institution:</strong>
    {{experiment.institution_name}}<br/>
  </p>

  {% if experiment.start_time and experiment.end_time %}
    <p>
      <strong>Date:</strong>
      {{ experiment.start_time|date:"jS F Y H:i" }} - {{ experiment.end_time|date:"jS F Y H:i" }}<br/>
    </p>
  {% endif %}

  <p>
    <div class="experiment_md_container">
        <strong style="float:left;">Experiment Metadata:</strong>

        {% if has_write_permissions %}{% if not experiment.public %}
            <a title="Add" class="jqModalExpA{{experiment.id}} fg-button ui-state-default fg-button-icon-solo ui-corner-all" href="{% url tardis.tardis_portal.views.add_experiment_par experiment.id %}">
                <span class="ui-icon ui-icon-plusthick"></span>
                Add
            </a>
        <div class="jqmAlert" id="jqmAlertExpA{{experiment.id}}">

            <div class="jqmAlertWindow">
                <div class="jqmAlertTitle clearfix">
                <h1>Add Parameters</h1><a href="#" class="jqmClose"><em>Close</em></a>
              </div>

              <div class="jqmAlertContent" id="jqmAlertContentexperimentA{{experiment.id}}">
              <p>Please wait... <img src="inc/busy.gif" alt="loading" /></p>
              </div>
            </div>
        </div>
        {% endif %}{% endif %}

        <a title="Show/Hide" class="experiment_metadata_toggle metadata_hidden fg-button ui-state-default fg-button-icon-solo ui-corner-all" href="/ajax/experiment_metadata/{{experiment.id}}/">
            <span class="ui-icon ui-icon-circle-triangle-e"></span>
            Show/Hide
        </a>
	</div>
    <div style="clear:both;"></div>
    <div class="experiment_metadata" style="display:none;"></div>
  </p>

  <p>
    <strong>Dataset Information:</strong>
    <div>
      <!-- <strong>Dataset Metadata: </strong>	 -->
      <div class="dataset_information">
	<ul>
	  <li><strong>Datasets:</strong> {{experiment.dataset_set.all.count}}</li>
	  <li><strong>Files:</strong> {{datafiles.count}}</li>
	  <li><strong>Size:</strong> {{size|filesizeformat}}</li>
	</ul>
      </div>
    </div>
  </p>

  <p>
    <strong>Experiment Last Updated:</strong>
    {{ experiment.update_time|date:"jS F Y H:i" }}<br/>
  </p>
  <div class="download_entire_experiment">
    {% for p in protocol %}
      <p>
	{% if p.0 %}
	  <strong><a href="{{p.1}}">Download Entire Experiment ({{p.0|upper}})</a></strong><br/>
	{% else %}
	  <strong><a href="{{p.1}}">Download Entire Experiment</a></strong><br/>
	{% endif %}
      </p>
    {% endfor %}
  </div>

  <p align="right">
    <br/>
    {% if owners %}
      <strong>Experiment Administrators </strong><br/>
      {% for owner in owners %}
        {% if owner.email %}
          <a href="mailto:{{owner.email}}">{{ owner.email}}</a>
        {% endif %}
        ({{ owner.username }})
        {% if not forloop.last %}
          <br/>
	{% endif %}
	</p>
	<p align="right">
	{% if experiment.public %}
		<em>This experiment is public.</em>
	{% endif %}
	{% if is_owner %}
	{% if not experiment.public %}
		<strong><a href="publish/">Publish Experiment</a></strong><br/>
	{% endif %}
	{% endif %}
      {% endfor %}
  </p>
{% endif %}

</div>

