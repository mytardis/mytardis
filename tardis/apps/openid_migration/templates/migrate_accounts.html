{% extends "tardis_portal/portal_template.html" %}

{% block script %}

  {% include "tardis_portal/javascript_libraries.html" %}

{% endblock %}


{% block content %}
<p class="alert alert-info">
  This page allows you to migrate accounts.
</p>
<!--
<div id="authList">

{% for userAuth in userAuthMethodList %}
<div class="authMethod" id="authMethod_{{ userAuth.2 }}">
  <table class="table table-condensed table-bordered">
    <tr>
      <th>Username:</th>
      <td> {{ userAuth.0 }} &nbsp;
      {% if userAuth.1 == 'Local DB' %}
        <a class="edit_auth" id="{{ userAuth.2 }}" href="javascript:void(0);">
          <i class="username-edit-icon fa fa-pencil"></i>
          <i class="username-close-icon fa fa-minus" style="display:none"></i>
        </a>
      {% else %}
        {% if isDjangoAccount %}
          <a class="remove_auth" id="{{ userAuth.2 }}" href="javascript:void(0);">
            <i class="fa fa-remove-circle"></i>
          </a>
        {% endif %}
      {% endif %}
      </td>
    </tr>
    <tr>
      <th>Authentication Method:</th>
      <td>{{ userAuth.1 }}</td>
    </tr>
  </table>
</div> <!-- authMethod -->
{% endfor %}

</div> <!--  authList -->


<div id="authForm">


    <form id="authForm" action="." method="post" class="form-horizontal">{% csrf_token %}
      <fieldset>
        <legend>Enter account details</legend>
        {% load bootstrap %}
        {% for field in authForm %}
          {{ field|bootstrap }}
        {% endfor %}
      </fieldset>
      <div class="form-actions">
        <button type="submit" id="link" class="btn btn-success">
         Migrate Accounts
        </button>
      </div>
    </form>
</div> <!-- authForm -->

    <div id="template-block" style="display: none">
        <p class="alert-error-msg alert alert-error">
            <a class="close" data-dismiss="alert">&times;</a>
            <span class="msg"></span>
        </p>
    </div>
    <div id="confirm-migrate" style="display: none">
         <p class="alert-info-msg alert alert-warning">
             <span class="msg">This process would involve merging the two accounts you own. <strong>Would you like to continue?</strong></span>
        </p>
        <div class="container" style="margin-left: 10px ; width: min-content">
              <h2>Old User</h2>
              <table class="table">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>mani0001</td>
                    <td>manish.kumar@monash.edu</td>
                  </tr>
                </tbody>
              </table>
        </div>
        <div class="container" style="margin-left: 10px; width: min-content">
              <h2>New User</h2>
              <table class="table">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>manish.kumar@monash.edu</td>
                    <td>manish.kumar@monash.edu</td>
                  </tr>
                </tbody>
              </table>
        </div>
        <div id="confirm_button" style="display: block">
        <button type="button" class="btn btn-success" id="confirm_true" style="margin-right: 20px ; width: 100px">Confirm</button>
        <button type="button" class="btn btn-danger"  id="confirm_false" style="margin-left: 20px ; width: 100px">Cancel</button>
        </div>
   </div>
    <div id="migration-message" style="display: none">
        <p class="alert-info-msg alert alert-success">
             <span class="msg"><strong>Congratulations !!</strong> your account has been successfully migrated</span>
        </p>
        <p class="alert-info-msg alert alert-warning">
             <span class="msg">Please use <strong>'Login via AAF'</strong> for all your future login to Store.Monash</span>
        </p>
    </div>
    <div id="spinner" style="display: none">
        <div class="center-parent" style="
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
        z-index: -1;">
            <div class="center-container" style="
        width: 60px;
        height: 60px;
        font-size: 60px;
        position: absolute;
        top: 34%;
        left: 62%;
        margin-top: -30px;
        margin-right: 0;
        margin-bottom: 0;
        margin-left: -30px;
        z-index: -1;">
                <i id="mo-spin-icon" class="fa fa-cog fa-spin"></i>
            </div>
        </div>
    </div>


<script>
var showChangePasswordForm = 0;
var authMethodDict = [];
{% for authKey, authDesc in allAuthMethods.items %}
authMethodDict["{{ authKey }}"] = "{{ authDesc }}";
{% endfor %}

var remove_auth = function(event) {
    if (confirm("Are you sure you want to delete this authentication method?")) {
        var divId = this.id;
        var data = { operation: 'removeAuth', authMethod: divId, csrfmiddlewaretoken: '{{csrf_token}}'};
    $.post("{% url 'tardis.tardis_portal.views.manage_auth_methods' %}", data, function(data) {
          var status = data.status;
          if (status == "success") {
            $('div').remove('#authMethod_' + divId);
            $('<option value="' + divId + '">' + authMethodDict[divId] + '</option>').insertAfter($("option:last"));
          }
          else {
              display_error(data.errorMessage, $("div #authMethod_" + divId));
          }
      }, "json");
    }
}

var edit_auth = function(event) {
  var divId = this.id;
  if (showChangePasswordForm == 0) {
    var changePassword = $('#template-block .form-change-password').clone();
    showChangePasswordForm = 1;
    changePassword.appendTo('#authMethod_' + divId);
    $('#' + divId + '.edit_auth username-edit-icon').css('display', 'none');
    $('#' + divId + '.edit_auth username-close-icon').css('display', 'inline');
  }
  else {
    showChangePasswordForm = 0;
    $('#authMethod_' + divId).find('.form-change-password').remove();
    $('#' + divId + '.edit_auth username-close-icon').css('display', 'none');
    $('#' + divId + '.edit_auth username-edit-icon').css('display', 'inline');
  }
}

var process_new_auth_entry = function(data) {
  var dataMap = data.data;
  var username = dataMap.username;
  var authenticationMethod = dataMap.authenticationMethod;

  var new_auth_method = $('#template-block .authMethod').clone();
  new_auth_method.attr('id', 'authMethod_'+authenticationMethod);
  new_auth_method.find('.remove_auth').attr('id', authenticationMethod);
  new_auth_method.find('.username').text(username);
  new_auth_method.find('.auth-method').text(authMethodDict[authenticationMethod]);
  new_auth_method.insertAfter($(".authMethod:visible:last"));

  var supportedAuthMethodsLength = dataMap.supportedAuthMethodsLen;
  if (supportedAuthMethodsLength == 0) {
    $('div').remove('#authForm');
  }
  else {
      $('option').remove("option[value='" + authenticationMethod + "']");
      $("#id_username").val("");
      $("#id_password").val("");
  }

};

var edit_account = function() {
  var currentPassword = $("#id_currentPassword").val();
    var password = $("#id_newPassword").val();
    var password1 = $("#id_newPassword1").val();

    if (currentPassword == "" || password == "" || password1 == "") {
      display_error("Sorry, all the password fields should be filled.", $("div.authMethod .form-change-password"));
    }
    else if (password != password1) {
        display_error("The passwords don't match.", $("div.authMethod .form-change-password"));
    }
    else {
      var data = {operation: 'editAuth', currentPassword: currentPassword, newPassword: password,
                  csrfmiddlewaretoken: '{{csrf_token}}'};
        $.post("/accounts/manage_auth_methods/", data, function(data) {
            var status = data.status;
            if (status == "success") {
                showChangePasswordForm = 0;
                $('div.authMethod').find('.form-change-password').remove();
                $('div.edit_auth username-close-icon').css('display', 'none');
                $('div.edit_auth username-edit-icon').css('display', 'inline');
                var msg_div = $('#template-block .alert-password-changed').clone();
                msg_div.appendTo('.authMethod').fadeIn("slow").animate({opacity: 1.0}, 5000).fadeOut("slow",function() { msg_div.remove(); });
            }
            else {
                display_error(data.errorMessage, $("div.authMethod .form-change-password"));
            }
        }, "json");
    }
    return false;
};

var link_account = function() {
  var username = $("#id_username").val();
    var password = $("#id_password").val();
    var authenticationMethod = $("#id_authenticationMethod").val();

    if (username != "" && password != "") {
      var data = {operation: 'addAuth', username: username, password: password, authenticationMethod: authenticationMethod,
                  csrfmiddlewaretoken: '{{csrf_token}}'
      };
      $.post("/apps/openid-migration/migrate-accounts/", data, function(data) {
          var status = data.status;
          if (status == "success") {
            process_new_auth_entry(data);
          }
          else if (status == "confirm") {

              $("#authForm").css('display','none')
              $('.alert-info').css('display','none')
              $("#confirm-migrate").css('display','block')
            if (false) {
              data = {operation: 'mergeAuth', username: username, password: password, authenticationMethod: authenticationMethod,
	              csrfmiddlewaretoken: '{{csrf_token}}'
	            };

              $.post("{% url 'tardis.apps.openid_migration.views.migrate_accounts' %}", data, function(data) {
                var status = data.status
                if (status == "success") {
                  process_new_auth_entry(data);
                }
                else {
                  display_error("Account merging failed!", $("#authForm"));
                }
              }, "json");
            }
          } else {
            display_error(data.errorMessage, $("#authForm"));
          }
      }, "json");
    }
    else {
        display_error("You need to provide all the necessary information to authenticate.", $("#authForm"));
    }
  return false;
};

var migrate_account= function () {
    $("#spinner").css('display', 'block')
    $("#confirm-migrate").css('opacity','.5')
    var username = $("#id_username").val();
    var password = $("#id_password").val();
    var authenticationMethod = $("#id_authenticationMethod").val();
    var data = {
        operation: 'migrateAccount', username: username, password: password, authenticationMethod: authenticationMethod,
        csrfmiddlewaretoken: '{{csrf_token}}'
    }
        $.post("{% url 'tardis.apps.openid_migration.views.migrate_accounts' %}", data, function(data) {
                var status = data.status
                if (status == "success") {
                    $("#spinner").css('display', 'none')
                  $("#confirm-migrate").css('display','none')
                  $("#migration-message").css('display','block')
                }
                else {
                  display_error("Account merging failed!", $("#authForm"));
                }
              }, "json");
}

var display_error = function(msg, elem) {
  // Create box from template
  var msgBox = $('#template-block .alert-error-msg').clone();
  // Fill in error message
  msgBox.find('.msg').text(msg);
  // Insert into DOM
  msgBox.insertBefore(elem).fadeIn("slow").animate({opacity: 1.0}, 5000).fadeOut("slow",function() { msgBox.remove(); });
};

$("#link").click(link_account);
$("#confirm_true").click(migrate_account)
$("#edit").live('click', edit_account);
$(".edit_auth").live('click', edit_auth);
$(".remove_auth").live('click', remove_auth);

</script>
{% endblock content %}
