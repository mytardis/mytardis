=======================
Authorisation Framework
=======================


Django Authorisation
====================

Django has a built-in authorisation/permission mechanism that is in use by
default.  It is enabled in MyTardis in ``default_settings.py`` together with
the custom object level permission framework described below.

.. code-block:: python

    AUTHENTICATION_BACKENDS = (
        'django.contrib.auth.backends.ModelBackend',
    	'tardis.tardis_portal.auth.authorisation.ACLAwareBackend',
        'tardis.tardis_portal.auth.cas.backends.CASBackend',
    )

Using the Central Authentication Service (CAS) Backend
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

To use a CAS Server for authentication the following settings must be overridden:

.. code-block:: python
	CAS_ENABLED = True
	CAS_SERVER_URL = 'https//<url of the CAS Service>/'
	CAS_SERVICE_URL = 'http://<url of the tardis instance>/'


* ``CAS_ENABLED`` must be set to ``True`` to turn on the CAS backend. This will 
  also enable the login button to redirect to the CAS server. 

* ``CAS_SERVER_URL`` must be set to the base URL of the CAS service. This can be 
  checked by using a browser to go to the login page via the URL: 
  `https//<url of the CAS Service>/login`

* ``CAS_SERVICE_URL`` must be set to the URL of the MyTardis instance. This will
  be passed to the CAS service so that it can redirect back to MyTardis after 
  authentication.

The following settings may be overridden as required:

.. code-block:: python
	CAS_LOGOUT_COMPLETELY = True

* ``CAS_LOGOUT_COMPLETELY`` may be set to ``False`` if your enterprise has a 
  single sign-in policy. The user will remain logged in via CAS even if they 
  have logged out of MyTardis.

For more information on CAS project see: http://jasig.github.io/cas    

Permissions
^^^^^^^^^^^

The Django default permissions are automatically available for each Model.
The verbs are ``add``, ``change``, ``delete``, and they can be queried on the
user object as follows:

.. code-block:: python

   user.has_perm('tardis_portal.add_experiment')
   user.has_perm('tardis_portal.add_dataset')
   user.has_perm('tardis_portal.change_experiment')
   user.has_perm('tardis_portal.delete_datasetparameterset')

There is a function in ``tardis.tardis_portal.auth.authservice`` called
``_set_user_from_dict`` that adds the following permissions for each new user
created using custom methods:

.. code-block:: python

   'add_experiment'
   'change_experiment'
   'change_group'
   'change_userauthentication'
   'change_experimentacl'

These permissions apply in general and are augmented by ACLs


Other Authentication Methods
============================


Users can be authenticated via the following additional methods:

Australian Access Federation (AAF)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Before AAF authentication can be used, the MyTardis instance must be registered
as a service with the AAF at `https://rapid.aaf.edu.au/registration`. 
When registering the service use the following urls:

* URL: 	 		`https://<url of the mytardis instance>/`
* Callback URL: `https://<url of the mytardis instance>/rc/auth/jwt/`
     
To enable AAF authentication the following settings must be overridden:

* ``RAPID_CONNECT_CONFIG['iss']``
	must be set to the appropriate AAF url, such as: 
	`https://rapid.test.aaf.edu.au` for testing, or 
	`https://rapid.aaf.edu.au` for production.
	
* ``RAPID_CONNECT_CONFIG['aud']`` 
	must be set to the service URL entered as part of the AAF registration 
	process.
	
* ``RAPID_CONNECT_CONFIG['secret']`` 
	must be set to the key entered as part of the AAF service
	registration process.

* ``RAPID_CONNECT_CONFIG['authnrequest_url']`` 
	must be set to the url generated by the AAF as confirmation of successful 
	service registration process.


Australian Access Federation (AAF) with defined entityID
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In addition to the above process, AAF authentication can be used with a 
defined entityID. This allows MyTardis to bypass the Organization selection
page and force AAF to use a specific identity provider. This can be enabled 
by overriding the following setting:

* ``RAPID_CONNECT_CONFIG['entityID']`` 
	can be set to a identity provider url,which can be found at the following url:
	`https://manager.test.aaf.edu.au/federationregistry/membership/identityprovider/list`


Multi-Modal Login
=================


MyTardis allows users to authenticate via multiple methods. Each method can 
be enabled independently using the ``LOGIN_FRONTENDS`` settings.

The method associated with the `Log In` button, on the portal template, can be 
changed using the setting:

* ``LOGIN_FRONTEND_DEFAULT`` 
	which by default is set to ``local``.

The home organization, if set, is used to strip the domain from emails to
identify the organization user id. 

* e.g. ``LOGIN_HOME_ORGANIZATION = 'rmit.edu.au'``

The valid authentication methods are defined using the appropriate 
``LOGIN_FRONTENDS`` settings. Valid keys include: ``aaf``, ``aafe``, ``cas``, 
and ``local``. 

* ``LOGIN_FRONTENDS['<key>']['enabled'] = True/False``
	By default only `local` is enabled.
	
* ``LOGIN_FRONTENDS['<key>']['label'] = '<value>'``
	The default values are as follows: ``local`` is 'Local', ``aaf`` is 'AAF', 
	``aafe`` is 'Home', and ``cas`` is 'CAS Server'.

If more than one method is enabled, then a dropdown menu, labelled `Other Logins`
will be enabled on the portal template, next to the default `Log In` button. 
This menu will include buttons for the additional login methods.


Object Level Permissions and Access Control Lists
=================================================


The main purpose of the ACL system is to manage per
experiment permissions. The architecture allows for future expansion to more
find grained permission management. However, at this stage only the Experiment
level is supported by the user interface.

Permissions are applied with a few predefined roles:

**read**
   read permission allows individuals and groups access to view an
   experiment.

**write**
   write permissions cover addition of new datasets and datafiles
   and also deletion of datafile.

**delete**
   delete permission allows deletion of datasets and experiments.

Roles are applied through the web using the *Control Panel* and can be
applied to either users or groups.

To make an experiment public requires an explicit publish action.


The ACL permissions can be queried on the user object just like standard
permissions, however, with the
addition of the object in question:

.. code-block:: python

   user.has_perm('tardis_acls.change_experiment', experiment)

Verbs currently available are ``change``, ``view``, ``delete``, ``owns``,
``share``.

The translation of ACLs to ``has_perm`` verbs is defined in a function in
``tardis.tardis_portal.auth.authorisation``.

To allow for querying on any object related to experiments, extra logic
was added to some of the models.
To support the logic, in addition to ACLs, ``has_perm`` calls model functions
named ``_has_VERB_perm``, which allows model-specific permission logic.

The current policy is that if those functions return True or False then that
result is returned without further checking. If they return an object,
permissions will be checked for this object thereby allowing delegation.
